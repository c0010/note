* Threat Intelligence 
** data source introduction
   - tags 标签说明
     #+BEGIN_VERSE
    scanners     扫描源
    spam         垃圾邮件
    botnets      僵尸网络客户端
    c&c          僵尸网络控制端
    malware      恶意软件
    phishing     钓鱼
    whitelist    白名单
    darknet      暗网
    ddos         拒绝服务攻击
    exploit      安全漏洞
    honeypot     蜜罐
    hijacked     劫持
    suspicious   可疑
    +Web Attacks  Web攻击+
     #+END_VERSE                                                            
   - confidence  数据源的可信度
     #+BEGIN_VERSE
      (9-10）Certain
      (7-8) Very Confident
      (6-7) Somewhat Confident
      (5-6) Not Confident
      (5) "50/50 shot"
      (0-4) Informational Data
     #+END_VERSE
   - 统计表

       [[http://7xpyfe.com1.z0.glb.clouddn.com/blog/20170616/135122999.png]]
   - 数据库内现在存储格式
     1. scrapy 爬虫
        更新机制： 同一数据源来的数据，威胁类型不变时，

                   只更新该类型记录更新时间,同时刷新这条ip/url的状态时间
        #+BEGIN_SRC json
          {
          "_id" : ObjectId("58b518df326aa7ed38218fa9"),
          "history" : [
              {
              "from" : "antispam.imp.ch",
              "threat" : "Spam Sources",
              "updated_time" : "2017-02-6T19:35:13"
              },
              {
              "from" : "reputation.alienvault.com",
              "threat" : "Botnet",
              "updated_time" : "2017-05-07T18:36:23"
              },
          ],
          "ip" : "1.160.211.142",
          "updated_time" : "2017-06-10T01:00:08"
          }
        
        #+END_SRC
     2. cif 格式

        更新机制: 无历史记录，以indicator为唯一id，存在即替换,目前只作为中间表
        #+BEGIN_SRC json
        {
        "_id" : ObjectId("593be9071d41c83f53a07bd4"),
        "confidence" : 7,
        "count" : 1,
        "description" : "",
        "group" : "everyone",
        "indicator" : "5.189.168.152",
        "lasttime" : "",
        "provider" : "blocklist.de",
        "rdata" : "",
        "tags" : "scanner",
        "tlp" : "green"
        }

        #+END_SRC
*** alexa.com
    亚马逊的alexa提供站点排名

    sum：1529
**** top-1000
     - tags: whitelist
     - confidence ：5  
     - source url : http://s3.amazonaws.com/alexa-static/top-1m.csv.zip 
     - total : 1529
     - cycle : 1 day
     - incremental : 100+ /day
#+BEGIN_SRC json
{
"_id" : ObjectId("593ba272256c1046ad056f91"),
"confidence" : 5,
"count" : 1,
"description" : "alexa #972",//站点排名
"group" : "everyone",
"indicator" : "11st.co.kr", //域名信息
"lasttime" : "",
"provider" : "alexa.com",
"rdata" : "",
"tags" : "whitelist",
"tlp" : "green"
}

#+END_SRC

*** reputation.alienvault.com
#+BEGIN_VERSE
    [[https://www.alienvault.com/who-we-are/alienvault-labs][alienvault-labs]] 实验室每天扫描获取全球的威胁与漏洞,付费产品每三十分钟更新一次数据
    产品提供14天免费试用
    Unified Security Management™ Simplifies Security in the Cloud & On-Premises
    AlienVault unifies all of your essential security tools in one location and combines them with real-time threat intelligence.
    数据源文件包过大爬取下载失败
    sum: 31978
#+END_VERSE
**** scanners
     - tags: scanner
     - confidence ：7  
     - source url : https://reputation.alienvault.com/reputation.data
     - total : 0
     - cycle : 1 day
     - incremental : 0 /day
**** spammers
     - tags: spam
     - confidence ：6  
     - source url : https://reputation.alienvault.com/reputation.data
     - total : 0
     - cycle : 1 day
     - incremental : 0 /day
**** malware
     - tags: malware/suspicious
     - confidence ：6  
     - source url : https://reputation.alienvault.com/reputation.data
     - total : 0
     - cycle : 1 day
     - incremental : 0 /day

*** osint.bambenekconsulting.com
    数据源爬取规则过老，需要修改规则或者重写爬虫

    目前库内只有7w

    C&C 被规整到了botnet内
    http://osint.bambenekconsulting.com/feeds/c2-dommasterlist.txt

    sum: 865311
    
**** cryptolocker-fqdn
     - tags: botnet
     - confidence ：9  
     - source url : http://osint.bambenekconsulting.com/feeds/dga-feed.txt
     - total : 6000
     - cycle : 1 day
     - incremental : - /day
    
**** zeus-fqdn
     - tags: botnet
     - confidence ：9  
     - source url : http://osint.bambenekconsulting.com/feeds/dga-feed.txt
     - total : 2000
     - cycle : 1 day
     - incremental : - /day

**** tinba-fqdn
     - tags: botnet
     - confidence ：9  
     - source url : http://osint.bambenekconsulting.com/feeds/dga-feed.txt
     - total : 13w
     - cycle : 1 day
     - incremental : - /day
#+BEGIN_SRC json
{
"_id" : ObjectId("593be9091d41c83f6aa07ba9"),
"count" : 1,
"indicator" : "209.15.13.134",
"tlp" : "white",
"group" : "everyone",
"description" : "suppobox c&c",
"tags" : "botnet",
"rdata" : "",
"confidence" : 6.5,
"provider" : "osint.bambenekconsulting.com",
"lasttime" : "2017-06-10T00:11:00.000000Z"
}

#+END_SRC

*** blocklist.de
    数据源提供 botnet scanner 数据

    扫描数据扫描端口

    sum : 68711
**** scanner 
     - tags: scanner
     - confidence ：7  
     - source url : 
        1. http://lists.blocklist.de/lists/ssh.txt
        2. http://lists.blocklist.de/lists/mail.txt
        3. http://lists.blocklist.de/lists/apache.txt
        4. http://lists.blocklist.de/lists/imap.txt
        5. http://lists.blocklist.de/lists/ftp.txt
        6. http://lists.blocklist.de/lists/sip.txt
        7. http://lists.blocklist.de/lists/bruteforcelogin.txt
     - total : -
     - cycle : 1 day
     - incremental : - /day

**** botnet
     - tags: scanner
     - confidence ：7  
     - source url : http://lists.blocklist.de/lists/bots.txt
     - total : -
     - cycle : 1 day
     - incremental : - /day
#+BEGIN_SRC json
{
"_id" : ObjectId("593be9071d41c83f53a07bd4"),
"confidence" : 7,
"count" : 1,
"description" : "",
"group" : "everyone",
"indicator" : "5.189.168.152",
"lasttime" : "",
"provider" : "blocklist.de",
"rdata" : "",
"tags" : "scanner",
"tlp" : "green"
}

#+END_SRC
*** umbrella.cisco.com
    一级域名

    sum：1134
**** top-1000
     - tags: whitelist
     - confidence ：5  
     - source url : http://s3-us-west-1.amazonaws.com/umbrella-static/top-1m.csv.zip
     - total : 1134
     - cycle : 1 day
     - incremental : 100+ /day
#+BEGIN_SRC json
{
"_id" : ObjectId("593be90a1d41c83fa8a07c1b"),
"confidence" : 5,
"count" : 1,
"description" : "cisco umbrella #401",
"group" : "everyone",
"indicator" : "t.co",
"lasttime" : "",
"provider" : "umbrella.cisco.com",
"rdata" : "",
"tags" : "whitelist",
"tlp" : "green"
} 

#+END_SRC 

*** csirtg.io
    Unsolicited Commercial Email(UCE)商业垃圾邮件

    https://csirtg.io/users/csirtgadgets/feeds/uce-urls

    feed有限制250条 需要继续观察数据量
    sum: 1037
**** scanner
     - tags: scanner
     - confidence ：9 
     - source url : https://csirtg.io/api/users/csirtgadgets/feeds/port-scanners.csv
     - total : -
     - cycle : 1 day
     - incremental :  /day
**** uce
     - tags: spam
     - confidence ：9  
     - source url : 
       1. https://csirtg.io/api/users/csirtgadgets/feeds/uce-urls.csv
       2. https://csirtg.io/api/users/csirtgadgets/feeds/uce-email-addresses.csv
       3. https://csirtg.io/api/users/csirtgadgets/feeds/uce-ip.csv
     - total : -
     - cycle : 1 day
     - incremental :  /day
**** darknet
     - tags: darknet
     - confidence ：9 
     - source url :https://csirtg.io/api/users/wes/feeds/darknet.csv
     - total : -
     - cycle : 1 day
     - incremental :  /day
     
*** danger.rulez.sk
     sum : 1254
**** scanner
     - tags: scanner
     - confidence ：9 
     - source url :http://danger.rulez.sk/projects/bruteforceblocker/blist.php
     - total : 1254
     - cycle : 1 day
     - incremental :  /day

*** dataplane.org

    sum : 46710
**** scanner
     - tags: scanner
     - confidence ：9 
     - source url :
       1. https://dataplane.org/sshclient.txt
       2. https://dataplane.org/sshpwauth.txt
       3. https://dataplane.org/sipquery.txt
       4. https://dataplane.org/sipinvitation.txt
       5. https://dataplane.org/sipregistration.txt
     - total : 1254
     - cycle : 1 day
     - incremental :  /day
*** emergingthreats.net
    sum: 1289
**** compromised-ips
     - tags: botnet,C&C
     - confidence ：8 
     - source url :
        https://rules.emergingthreats.net/blockrules/compromised-ips.txt,
        https://rules.emergingthreats.net/blockrules/emerging-compromised.rules,
        https://rules.emergingthreats.net/blockrules/emerging-botcc.excluded,
        https://rules.emergingthreats.net/blockrules/emerging-compromised.suricata.rules,
        https://rules.emergingthreats.net/blockrules/emerging-compromised.suricata.rules
        https://rules.emergingthreats.net/blockrules/emerging-botcc.suricata.rules,
        https://rules.emergingthreats.net/blockrules/emerging-botcc.rules
        https://rules.emergingthreats.net/blockrules/emerging-botcc.portgrouped.rules,
        https://rules.emergingthreats.net/blockrules/emerging-botcc.portgrouped.suricata.rules,
     - total : 1254
     - cycle : 1 day
     - incremental :  /day

*** malc0de.com
    提取代码出现问题

    sum : 0
**** malware
     - tags: malware
     - confidence ：9
     - source url :http://malc0de.com/rss/
     - total : 
     - cycle : 1 day
     - incremental :  /day

*** mirc.com
    sum : 191
**** domains
     - tags: whitelist
     - confidence ：8
     - source url :http://www.mirc.com/servers.ini
     - total : 
     - cycle : 1 day
     - incremental :  /day
       
*** netlab.360.com
    Domain generation algorithms (DGA)

    botnet 和 C&C 放在一起了
**** exploit malware
     - tags:exploit malware 
     - confidence ：7
     - source url :http://data.netlab.360.com/feeds/ek/magnitude.txt
     - total : 
     - cycle : 1 day
     - incremental :  /day
**** botnet
     - tags:botnet
     - confidence ：7
     - source url :
#+BEGIN_VERSE
       http://data.netlab.360.com/feeds/dga/bamital.txt
       http://data.netlab.360.com/feeds/dga/banjori.txt
       http://data.netlab.360.com/feeds/dga/banjori.txt
       http://data.netlab.360.com/feeds/dga/chinad.txt
       http://data.netlab.360.com/feeds/dga/conficker.txt
       http://data.netlab.360.com/feeds/dga/cryptolocker.txt
       http://data.netlab.360.com/feeds/dga/dircrypt.txt
       http://data.netlab.360.com/feeds/dga/dyre.txt
       http://data.netlab.360.com/feeds/dga/fobber.txt
       http://data.netlab.360.com/feeds/dga/gameover.txt
       http://data.netlab.360.com/feeds/dga/gspy.txt
       http://data.netlab.360.com/feeds/dga/locky.txt
       http://data.netlab.360.com/feeds/dga/madmax.txt
       http://data.netlab.360.com/feeds/dga/mirai.txt
       http://data.netlab.360.com/feeds/dga/murofet.txt
       http://data.netlab.360.com/feeds/dga/necurs.txt
       http://data.netlab.360.com/feeds/dga/nymaim.txt
       http://data.netlab.360.com/feeds/dga/proslikefan.txt
       http://data.netlab.360.com/feeds/dga/pykspa.txt
       http://data.netlab.360.com/feeds/dga/qadars.txt
       http://data.netlab.360.com/feeds/dga/ranbyus.txt
       http://data.netlab.360.com/feeds/dga/rovnix.txt
       http://data.netlab.360.com/feeds/dga/shifu.txt
       http://data.netlab.360.com/feeds/dga/simda.txt
       http://data.netlab.360.com/feeds/dga/suppobox.txt
       http://data.netlab.360.com/feeds/dga/symmi.txt
       http://data.netlab.360.com/feeds/dga/tempedreve.txt
       http://data.netlab.360.com/feeds/dga/tinba.txt
       http://data.netlab.360.com/feeds/dga/tofsee.txt
       http://data.netlab.360.com/feeds/dga/vawtrak.txt
       http://data.netlab.360.com/feeds/dga/vidro.txt
#+END_VERSE
     - total : 
     - cycle : 1 day
     - incremental :  /day

*** nothink.org
**** scanner
     - tags:exploit malware 
     - confidence ：7
     - source url :http://www.nothink.org/blacklist/blacklist_ssh_day.txt
     - total : 
     - cycle : 1 day
     - incremental :  /day
*** openphish.com
**** phishing
     - tags:phishing
     - confidence ：9
     - source url :https://openphish.com/feed.txt
     - total : 
     - cycle : 1 day
     - incremental :  /day
*** packetmail.net
**** scanner honeynet
     - tags: honeynet
     - confidence ：8
     - source url :
       1. https://www.packetmail.net/iprep.txt
       2. https://www.packetmail.net/iprep_mail.txt
       3. https://www.packetmail.net/iprep_ramnode.txt
     - total : 
     - cycle : 1 day
     - incremental :  /day

*** phishtank.com
**** phishing
     - tags:phishing
     - confidence ：9
     - source url : http://data.phishtank.com/data/%7Btoken%7D/online-valid.json.gz
     - total : 
     - cycle : 1 day
     - incremental :  /day
*** isc.sans.edu
**** scanner
     - tags: scanner
     - confidence ：7-9
     - source url :
       1. https://isc.sans.edu/feeds/suspiciousdomains_Low.txt
       2. https://isc.sans.edu/feeds/suspiciousdomains_High.txt
       3. https://isc.sans.edu/feeds/suspiciousdomains_Medium.txt
       4. https://isc.sans.edu/feeds/block.txt
     - total : 
     - cycle : 1 day
     - incremental :  /day
*** spamhaus.org
**** hijacked 
     被劫持数据
     - tags: hijacked
     - confidence ：9
     - source url :
       1. http://www.spamhaus.org/drop/drop.txt 
       2. http://www.spamhaus.org/drop/edrop.txt
       3. https://www.spamhaus.org/drop/dropv6.txt
       4. https://www.spamhaus.org/drop/asndrop.txt
     - total : 
     - cycle : 1 day
     - incremental :  /day
*** vxvault.net 
    爬虫有问题
**** malware
     - tags: botnet
     - confidence ：10
     - source url :http://vxvault.net/URL_List.php
     - total : 
     - cycle : 1 day
     - incremental :  /day

*** abuse.ch
    sum :16810
**** sslbl.abuse.ch
     - tags: botnet
     - confidence ：10
     - source url :
       1. https://sslbl.abuse.ch/blacklist/sslipblacklist.csv
       2. https://sslbl.abuse.ch/blacklist/dyre_sslipblacklist.csv
       3. https://sslbl.abuse.ch/blacklist/sslblacklist.csv
     - total :2384 
     - cycle : 1 day
     - incremental :  /day
**** zeustracker.abuse.ch
     - tags: botnet
     - confidence ：9
     - source url :
#+BEGIN_VERSE
       http://zeustracker.abuse.ch/monitor.php?urlfeed=configs
       http://zeustracker.abuse.ch/monitor.php?urlfeed=configs
       http://zeustracker.abuse.ch/monitor.php?urlfeed=dropzones
       http://zeustracker.abuse.ch/blocklist.php?download=domainblocklist
       http://zeustracker.abuse.ch/blocklist.php?download=ipblocklist
#+END_VERSE
     - total : 673
     - cycle : 1 day
     - incremental :  /day

**** feodotracker.abuse.ch
    sum : 903
     - tags: botnet
     - confidence ：6-8 
     - source url :
#+BEGIN_VERSE
       1. https://feodotracker.abuse.ch/blocklist/?download=domainblocklist 8 domain
       2. https://feodotracker.abuse.ch/blocklist/?download=ipblocklist  6 ip
#+END_VERSE
     - total : 
     - cycle : 1 day
     - incremental :  /day
**** ransomware.abuse.ch
     - tags:botnet
     - confidence ：9
     - source url :http://ransomwaretracker.abuse.ch/feeds/csv
     - total :12850
     - cycle : 1 day
     - incremental :  /day
*** otx.alienvault.com
**** otx 
     - tags: DDos ,C&C,Malware,Proxy,Phishing,Scanner,suspicious
     - confidence ：5
     - source url :
       1. https://sslbl.abuse.ch/blacklist/sslipblacklist.csv
       2. https://sslbl.abuse.ch/blacklist/dyre_sslipblacklist.csv
       3. https://sslbl.abuse.ch/blacklist/sslblacklist.csv
     - total :
     - cycle : 1 day
     - incremental :  /day
       
*** DONE antispam.imp.ch
    CLOSED: [2017-06-28 Wed 10:38]
    - State "DONE"       from ""           [2017-06-28 Wed 10:38]
    imp.ch 的反垃圾邮件 共享feed项目,声称每15分钟更新一次

    但已经停止更新了。
**** spam
     - tags: Spam Sources
     - confidence ：9
     - source url :http://antispam.imp.ch/spamlist
     - total : 943
     - cycle : 15 minutes
     - incremental : 0/day
*** dragonresearchgroup.org
**** scanner
     - tags: scanner
     - confidence ：9
     - source url :
       1. http://dragonresearchgroup.org/insight/sshpwauth.txt
       2. http://dragonresearchgroup.org/insight/http-report.txt
     - total :
     - cycle : 1 day
     - incremental :  /day
*** watcherlab.com
**** cc
     - tags: cc
     - confidence ：9
     - source url :http://feed.watcherlab.com/
     - total :
     - cycle : 1 day
     - incremental :  /day
*** 统计表
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 |                              | scanner | spam | botnet | c&c | malware | phishing | whitelist | darknet | ddos | exploit | honeypot | hijacked | suspicious | data-type         |     sum |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | alexa.com                    |         |      |        |     |         |          |         5 |         |      |         |          |          |            | DOMAIN            |    1529 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | reputation.alienvault.com    |       7 |    6 |        |     |       6 |          |           |         |      |         |          |          |            | IP                |   31978 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | osint.bambenekconsulting.com |         |      |      9 |     |         |          |           |         |      |         |          |          |            | IP                |  865311 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | blocklist.de                 |       7 |      |      7 |     |         |          |           |         |      |         |          |          |            | IP                |   68711 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | umbrella.cisco.com           |         |      |        |     |         |          |         5 |         |      |         |          |          |            | DOMAIN            |    1134 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | csirtg.io                    |       9 |    9 |        |     |         |          |           |       9 |      |         |          |          |            | IP,URL,           |    1037 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | danger.rulez.sk              |       9 |      |        |     |         |          |           |         |      |         |          |          |            | IP                |    1254 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | dataplane.org                |       9 |      |        |     |         |          |           |         |      |         |          |          |            | IP                |   46710 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | emergingthreats.net          |         |      |        |     |       8 |          |           |         |      |         |          |          |            | IP                |    1289 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | abuse.ch                     |         |      |   8-10 |     |         |          |           |         |      |         |          |          |            | URL ,IP ,MD5      |   16810 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | malc0de.com                  |         |      |        |     |       9 |          |           |         |      |         |          |          |            | URL,IP,MD5        |       0 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | mirc.com                     |         |      |        |     |         |          |         8 |         |      |         |          |          |            | URL               |     191 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | netlab.360.com               |         |      |      7 |     |       7 |          |           |         |      |       7 |          |          |            | IP,URL,DOMAIN,MD5 |  889955 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | nothink.org                  |       7 |      |        |     |         |          |           |         |      |         |          |          |            | IP                |     193 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | openphish.com                |         |      |        |     |         |        9 |           |         |      |         |          |          |            | URL               |    5352 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | packetmail.net               |       8 |      |        |     |         |          |           |         |      |         |        8 |          |            | IP                |   16424 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | phishtank.com                |         |      |        |     |         |        9 |           |         |      |         |          |          |            | IP                |   27128 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | isc.sans.edu                 |       8 |      |        |     |         |          |           |         |      |         |          |          |        7-9 | IP                |       0 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | spamhaus.org                 |         |      |        |     |         |          |           |         |      |         |          |        9 |            | ASN,IPv6,Network  |    1241 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | vxvault.net                  |         |      |        |     |       9 |          |           |         |      |         |          |          |            | IP                |     196 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | otx.alienvault.com           |       5 |    5 |        |     |       5 |        5 |           |         |    5 |         |          |          |          5 | IP,URL,MD5        |       0 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | antispam.imp.ch              |         |    9 |        |     |         |          |           |         |      |         |          |          |            | IP                |       0 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | dragonresearchgroup.org      |       9 |      |        |     |         |          |           |         |      |         |          |          |            | IP                |       0 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | watcherlab.com               |         |      |        |   9 |         |          |           |         |      |         |          |          |            | IP                |       0 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
 | sum                          |         |      |        |     |         |          |           |         |      |         |          |          |            |                   | 1976443 |
 |------------------------------+---------+------+--------+-----+---------+----------+-----------+---------+------+---------+----------+----------+------------+-------------------+---------|
#+TBLFM: @36$14='(+ @1$14..@36$14);N
*** TODO other source 
    - State "TODO"       from ""           [2017-06-16 Fri 13:11]
    1. spamhaustech
       https://www.spamhaustech.com/protecting-mail-streams/
    2. abusix
       https://www.abusix.com/
    3. apwg.org
       https://apwg.org/
       2003年创建的国际跨行业情报联盟 出网络钓鱼的报告可供下载

       没找到feed源

       提供数据分享的方式 https://sourceforge.net/projects/ecrisp-x/
    4. http://txt.proxyspy.net/proxy.txt
** CIF 
*** Bearded-Avenger install
    [[http://csirtgadgets.org/collective-intelligence-framework/][Collective Intelligence Framework]]:
    CIF是网络威胁情报管理系统，一个开源的框架，能帮助我们解析:规范化:存储:查询:共享和生成

    威胁情报的数据集。最主要的情报形式是：IP:Domain:URL

    [[http://7xpyfe.com1.z0.glb.clouddn.com/blog/20170606/160335989.png]]

    情报收集框架包括：
    - CIF Client
    - CIF-Router
    - CIF-Smrt
    - CIF-Tokens
    - CIF-Worker
    [[https://github.com/csirtgadgets/massive-octo-spice/wiki/CIF-Architecture-Overview][CIF Architecture Overview:]]
#+BEGIN_VERSE
       CIF 设计框架介绍
       How CIF fetches, parses and normalizes data
       How CIF post-processes data
       How CIF stores data
       How the CIF API allows data to be queried and submitted
       How CIF permissions data
       How CIF produces feeds of data
#+END_VERSE
    [[https://github.com/csirtgadgets/bearded-avenger-deploymentkit/wiki][Bearded-Avenger]]:
    作为CIF的替代品，bearde-Avenger 安装很容易
   #+BEGIN_VERSE
   $ tar -zxvf bearded-avenger-deploymentkit-3.0.x.tar.gz
   $ cd bearded-avenger-deploymentkit-3.0.x
   $ sudo bash easybutton.sh
   #+END_VERSE 
    ubuntu14.04正常安装报错，折腾了半天没时间搞了，官方提供Docker install
    #+BEGIN_VERSE
    $ docker pull csirtgadgets/cif:latest
    $ docker run --name cif -d -p 5000:5000 csirtgadgets/cif
    $ docker ps
    $ docker exec -it 9121af6cabed /bin/bash
    #+END_VERSE
    执行cif命令报下面的错误
    #+BEGIN_SRC 
    root@9121af6cabed:/bearded-avenger-3.0.0a13# cif --tags malware --limit 5
    Unable to read /root/.cif.yml config file
    #+END_SRC
    先读取cif.yml
    #+BEGIN_SRC 
CONFIG_PATH = os.environ.get('CIF_CONFIG_PATH', os.path.join(os.getcwd(), 'cif.yml'))
if not os.path.isfile(CONFIG_PATH):
    CONFIG_PATH = os.path.join(os.path.expanduser('~'), '.cif.yml')
    #+END_SRC 
    查看README.md 执行下面语句 CIFv3并不需要参考[[https://github.com/csirtgadgets/bearded-avenger-deploymentkit/wiki/Docker][文档]] 中所说的创建/root/.cif.yml文件 
    #+BEGIN_VERSE
    $ mkdir -p log && cp hacking/develop.conf hacking/local.conf
    $ cif-store -d --token-create-admin cif.yml
    $ cif-store -d --token-create-hunter cif-router.yml
    $ cif-store -d --token-create-smrt csirtg-smrt.yml
    #+END_VERSE
    执行后还是不能使用 官方docker源很坑

    docker search cif 找到了 ventz/cif 可以使用，但是安装后发现系统过于庞大

    对于我只想使用smrt抓取数据的来说，我更需要cif-smrt功能，好在官方把这部分

    功能提取出来了[[https://github.com/csirtgadgets/csirtg-smrt-py][csirtg-smrt-py]] 项目



    
*** csirtg-smrt-py
    使用YAML来规范数据，爬取feed数据源
    
    sudo pip install csirtg-smrt
    [[http://7xpyfe.com1.z0.glb.clouddn.com/blog/20170608/144738024.png]]
    
    测试了几个数据源如果feed为zip的压缩包，网络不是很顺畅的情况下无法正常下载爬取数据

    总的来说CIF不是很稳定，也不太适合我们公司情报收集，但是[[https://github.com/csirtgadgets/bearded-avenger/tree/master/rules][数据源]] 可以作为扩充
 
    下载github project中的单个目录 可以通过[[https://github.com/MinhasKamal/DownGit][DownGit]] 创建下载链接

    
*** source list use
    利用pyyaml解析yml

    sudo pip install pyyaml

    使用官方提供的yml配置文件定时抓取feed数据

    脚本每小时跑一遍
    代码如下：[[https://github.com/Nanue1/csirtg-smrt/blob/master/smrt.py][github]]
    #+BEGIN_SRC python
import yaml
import time
import json
import os
import sys
import logging
import requests
import traceback
import subprocess
import pymongo
from multiprocessing import Process,Queue,Value


CONF_PATH = os.path.abspath('.')+"/rule"
log_xpath="/tmp/%s.log" % os.path.basename(__file__)
PROCESS_NUM = 200


def init_log(log_xpath):
    logging.basicConfig(level=logging.DEBUG,
                format='%(asctime)s %(filename)s[line:%(lineno)d] %(levelname)s %(message)s',
                datefmt='%Y %b %d %H:%M:%S',
                filename=log_xpath,
                filemode='w')

def bulk_upsert_mongo(arg_list,coll):
    for dict_data in arg_list:
        #coll.update({"indicator":dict_data["indicator"]},{"$set":{"count":dict_data["count"],"tlp":dict_data["tlp"],"group":dict_data["group"],"description":dict_data["description"],"tags":dict_data["tags"],"rdata":dict_data["rdata"],"confidence":dict_data["confidence"],"provider":dict_data["provider"],"lasttime":dict_data["lasttime"]}},upsert=True)
        coll.insert(dict_data)
        #logging.info('insert %s' % dict_data["indicator"] )


def cmd_exc(flag):
    conn=pymongo.MongoClient('Mongo_IP',27017)
    db=conn["threat_cif"]
    coll=db["smrt"]
    while True:
        if cmds_queue.empty() and flag.value==1: 
            break
        else:
            try:
                cmd_smrt= cmds_queue.get(timeout=8)
                p = subprocess.Popen(cmd_smrt, shell=True,stdout=subprocess.PIPE)
                p.wait()
                time.sleep(10)
                logging.info('%s status: %s' % (cmd_smrt,p.poll()))
                if p.poll() == 0:
                    content= json.loads(p.stdout.read())
                    bulk_upsert_mongo(content,coll)
                elif p.poll() is  None:
                    p.kill()
                    logging.error('%s  returncode: %s timeout over 10s' % (cmd_smrt,p.returncode))
                else:
                    logging.error('%s status:%s, returncode: %s' % (cmd_smrt,p.poll(),p.returncode))
            except:
                logging.info(traceback.format_exc().splitlines())
                pass
    sys.exit()

def parse_yml():
    for yml_name in os.listdir(CONF_PATH): 
        if yml_name.endswith(".yml"):
            dic_yml = yaml.load(open(yml_name))['feeds']
            for key in dic_yml :
                cmd_smrt = "/usr/local/bin/csirtg-smrt -r " + yml_name + " -f " + key + " --format json"
                cmds_queue.put(cmd_smrt)

def run():
    end_flag = Value('i', 0)
    ps = [Process(target=cmd_exc,args=(end_flag,)) for x in xrange(PROCESS_NUM)]
    for p in ps:
        p.start()
    parse_yml()
    end_flag.value = 1
    for p in ps:
        p.join()

if '__main__' == __name__:
    if not os.path.exists(CONF_PATH):
        print "conf file not exists"
        sys.exit()
    else:
        os.system("rm -rf /tmp/smrt/")
        os.chdir(CONF_PATH)
    init_log(log_xpath)
    cmds_queue = Queue(100)
    session = requests.Session()
    run()






    
    #+END_SRC 
    


