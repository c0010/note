* Docker入门
  杨保华 Docker技术入门与实战
** 初识Docker
   可以简单的将Docker容器理解为一种沙盒，每个容器内运行一个应用，不同的容器互相隔离，容器之间可以建立通信机制。容器的创建和停止都十分快速，容器自身对资源的需求也十分有限，远远低于虚拟机。
   
   与传统虚拟机比较，Docker容器快，对系统资源需求少，一台主机可以运行数千个Docker容器,docker通过git的操作管理减少学习成本，通过Dockerfile配置文件来灵活自动化创建和部署

   传统方式是硬件层面实现虚拟化，需要有额外的虚拟机管理应用和虚拟机操作系统层，Docker容器是操作系统层面上实现的虚拟化，直接复用本地主机的操作系统，因此更加轻量级

   [[http://7xpyfe.com1.z0.glb.clouddn.com/blog/20171018/113219426.png]]
  
** Docker核心概念
   1. Image
   2. Container

      镜像自身是只读的，容器从镜像启动的时候，Docker会在镜像的最上层创建一个可写层，镜像本身将保持不变
   3. Repository

      Docker集中存放镜像文件的场所

      目前最大的公开仓库是Docker Hub 国内 Docker Pool

      Registry 注册服务器包含众多Repository

* Docker Image
** 获取镜像
   docker pull NAME[: TAG] 
   #+BEGIN_SRC 
     docker pull ubuntu  
     不指定TAG默认选择latest标签,最新版本的镜像
     docker pull registry.hub.docker.com/ubuntu :latest
     #+END_SRC
** 查看镜像信息

   - docker images  #查看本地所有镜像

   - docker inspect 747cb2d60bbe #查看镜像信息
   
** 搜寻镜像
   
   - docker search mysql #搜索远端仓库中共享的镜像

     #+BEGIN_SRC 
     docker search k8s --no-trunc=false --filter=stars=1 --filter=is-automated=true
     
     --filter=is-automated=true #只显示自动创建的镜像
     --no-trunc=false  #输出信息不截断显示
     --filter=stars=0 #指定星级以上的镜像
     #+END_SRC
** 删除镜像

   docker rmi IMAGE[IMAGE..] #IMAGE可以是标签或者是ID

   #+BEGIN_SRC 
   docker rmi ff4 -f
   image 创建的容器存在的时候，是无法删除删除的 -f 强制删除
   #+END_SRC
** 创建镜像
   1. 基于已有image的容器创建
      docker commit [OPTIONS] CONTAINER [REPOSITORY[: TAG]]

      #+BEGIN_SRC 
        docker commit -m "add a test" -a 'manue1' -p 836 centos_test:v1.0 

        -a 作者 -m  提交信息 -p 提交时暂停容器运行
      #+END_SRC
   2. 基于本地模版导入
      下载系统镜像模板
      https://openvz.org/Download/template/precreated

      cat xx.tar.gz | docker import - ubuntu:16.04
   3. 基于Dockerfile创建
** 存出和载入镜像

   docker save -o ubuntu-16.04.tar ubuntu:latest

   docker load --input ubuntu-16.04.tar

** 上传镜像
   docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]
   docker push TARGET_IMAGE[: TAG]
   #+BEGIN_SRC 
     需要先修改本地仓库name为远程仓库名，必须先创建远程仓库manue1sec/test
     - docker tag 3a4 manue1sec/test:u_test
     - docker push manue1sec/test
   #+END_SRC
* Docker Container
** 创建容器
     
     docker create -it ubuntu

     docker run -it ubuntu /bin/bash  创建并启动容器，-t启动一个虚拟终端，-i保持终端 -d 在后台守护运行

** 启动终止容器
     docker start d3e

     docker kill ce5 

     docker ps -a #显示所有容器
** 进入容器
     docker attach 18a
     docker exec -ti 24c /bin/bash  (推荐)
** 删除容器
     docker rm 18a
** 导入和导出容器

     docker export 18a > ubuntu_container.tar  作为镜像

     docker import a.tar

* Docker use note
** Docker install
   1. 图解Docker
      [[http://7xpyfe.com1.z0.glb.clouddn.com/blog/20170607/115341763.png]]
   2. [[https://docs.docker.com/engine/installation/][官网文档]] 有详细说明
      国内网速很慢，采用了阿里云的[[https://yq.aliyun.com/articles/7695][镜像源]]
      : curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/intranet | sh -

      [[http://7xpyfe.com1.z0.glb.clouddn.com/blog/20170607/131800763.png]]
   
** Docker command
   - service docker start/stop
   - docker rmi ventz/cif
   - docker images 命令查看本地的镜像列表
   - docker inspect cif 查看指定镜像的详细信息
   - docker ps -l 查看我们正在运行的容器 -l 最后状态  
   - docker exec -it 9121af6cabed /bin/bash
   - docker stop cif 停止容器
   - docker rm -f cif  运行冲突 remove it using
   - docker run --name cif -d -p 5000:5000 csirtgadgets/cif
         
* common problem
  1. ImportError: No module named apt_pkg
     安装docker 执行 sudo add-apt-repository 的时候报错
     Solve it by this:
     /usr/lib/python3/dist-packages# cp apt_pkg.cpython-34m-x86_64-linux-gnu.so apt_pkg.so